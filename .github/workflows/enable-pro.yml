name: "Enable Ubuntu Pro in LXD VM"
on:
  workflow_call:
    inputs:
      workload:
        description: 'Commands to run inside the VM after Pro FIPS-updates is enabled'
        required: true
        type: string
      checkout_repo:
        description: 'Repository to checkout (e.g., opensc/opensc). Leave empty to skip.'
        required: false
        type: string
        default: ''
    secrets:
      UBUNTU_PRO_TOKEN:
        required: true
jobs:
  setup-pro-with-fips-updates:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      if: ${{ inputs.checkout_repo != '' }}
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.checkout_repo }}
        path: shared/repo
    - name: Setup LXD
      uses: canonical/setup-lxd@main
      with:
        channel: latest/edge
    - name: Launch VM
      run: |
        lxc launch ubuntu:24.04 ubuntu-pro --vm -c limits.cpu=2 -c limits.memory=4GiB
        # Wait for LXD agent to be available
        while ! lxc exec ubuntu-pro -- true 2>/dev/null; do
          sleep 1
        done
        # Wait for cloud-init to finish
        lxc exec ubuntu-pro -- cloud-init status --wait

    - name: Enable Pro
      run: |
        # Pull out the token from the secrets
        token=${{ secrets.UBUNTU_PRO_TOKEN }}
        # Attach the token to the VM
        lxc exec ubuntu-pro -- pro attach $token

    - name: Add shared directory
      run: |
        mkdir -p ${{ github.workspace }}/shared
        lxc config device add ubuntu-pro shared disk source=${{ github.workspace }}/shared path=/shared

    - name: Enable fips-updates
      run: |
        lxc exec ubuntu-pro -- pro enable --assume-yes fips-updates

    - name: Reboot
      run: |
        lxc restart ubuntu-pro
        sleep 5 # Give it a moment to start rebooting
        # Wait for LXD agent to be available
        while ! lxc exec ubuntu-pro -- true 2>/dev/null; do
          sleep 1
        done

    - name: Workload
      run: |
        
        echo "PWD: $PWD"
        echo "Contents of current directory:"
        ls -la
        echo "Contents of GitHub workspace:"
        ls -la ${{ github.workspace }}
        lxc exec ubuntu-pro -- bash -c 'cd /shared/repo; ${{ inputs.workload }}'

    - name: Detach from Pro
      run: |
        # Exit 129 (SIGHUP) can occur when pro detach terminates services; ignore it
        lxc exec ubuntu-pro -- pro detach --assume-yes --format json || [[ $? -eq 129 ]]
